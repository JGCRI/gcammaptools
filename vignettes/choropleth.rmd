---
title: "How to use the Choropleth function in GCAMMaps package"
author: "Jason Evanoff"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use the Choropleth function in GCAMMaps package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=10, fig.height=6
)
```

```{r checknamespace, echo=FALSE}
if(!requireNamespace('rgcam', quietly=TRUE)) {
    stop('The rgcam package is required to build this vignette')
}
if(!requireNamespace('rgis', quietly=TRUE)) {
    stop('The rgis package is required to build this vignette')
}
```

## GCAM Mapping Tools Examples - Choropleth function

### Introduction

One of the most commonly requested map types is the choropleth map, which is a thematic map in which areas are shaded in proportion to a statistical variable such as population density or per-capita income. This vignette explains how to use this package to dynamically generate and customize a simple choropleth map by inputting a combination of shape files and data objects/files. This function has been designed to be both flexible regarding the scope and complexity of its arguments and simple to use with default values available for most arguments. 

### Example 1: Building your first map - Show World Health Organization (WHO) Healthy Life Expectancy (HALE) at birth (years)

To get started building a minimal choropleth map, there are 5 required fields that must be passed to the function: `shape_data`, `map_data` (or `shape_data_field` discussed later), `shape_key_field` and `data_key_field.` 

* The `shape_data` argument must be either an SF object or point to a .shp file in a directory that includes all necessary accompanying files (.dbf, .prj, etc). 
* The `map_data` argument must either be a data frame variable or point to a .csv file in comma delimited format. 
* The `data_col` argument points to the 'value' field in the `map_data` object that will be the plot's output. 
* The `shape_key_field` argument must point to the field in your shape object that will be used to join the shape and data objects together. 
* The `data_key_field` argument must point to the field in your data object that will be used in the join operation. 

These fields must be compatible in a join operation. In the case of excess data, this function will left_join to preserve shape data (unjoinable map data will be lost). For the purposes of this example, the following arguments will be used:


* `shape_data` - "data/tm_world_borders_simpl-0.3.shp" - A simple world map with country borders
* `map_data` - "data/data.csv" - CSV file containing WHO HALE data 2000-2016
* `data_col` - "X2016" - Instructs the function to use the 2016 column from the csv
* `shape_key_field` - "NAME" - Tells the function to use the field "NAME" in the shape object for joining purposes
* `data_key_field` - "Country" - Tells the function to use the "Country" field in the csv/data object for joining purposes

```{r load_data, warning=FALSE}
### Load the example scenario data.
data_file <- system.file("data", "data.csv", package="gcammaptools") 
shape_file <- system.file("data", "tm_world_borders_simpl-0.3.shp", package="gcammaptools")
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country")
plot(output)
```

## Customizing the Output
Now that we have seen how easy it is to build a simple choropleth map, let's learn how to fill in and customize the details like giving the map and legend titles and customizing the axes. There are 4 main label fields that control the output text and should be self-explanatory.

The arguments added in this call:

* `map_title` - "2016 Healthy Life Expectancy (HALE) at Birth" 
* `map_legend_title` - "HALE (years)" 
* `map_x_label` - "Longitude"
* `map_y_label` - "Latitude"

```{r customize_data, warning=FALSE}
### Customize the map
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country", 
                                   map_title = "2016 Healthy Life Expectancy (HALE) at Birth",
                                   map_legend_title = "HALE (years)", map_x_label = "Longitude", 
                                   map_y_label = "Latitude" )
plot(output)
```

### Saving the Output

Now that we have created a simple map, let's take a look at how to save the output and what options are available. The relevant arguments here are `output_file` and `dpi`. The `output_file` argument should point to a fully qualified path such as  "c:/temp/output.png" or other file path that R is able to process. The `output_file` argument should also include the file name appended at the end as well as the desired file type (Types accepted: "eps", "ps", "tex", "pdf", "jpeg", "tiff", "png", "bmp", "svg"). The `dpi` argument sets the dots per inch resolution and should be a number between 30 and 300 depending on your output and printing requirements.

Depending on the system you are running this vignette on, you may need to customize the following `output_file` path to get the code to run correctly. 

The arguments added in this call:

* `output_file` - "E:/temp/example_map.png" - Tells the function to save as a PNG file called example_map.png
* `dpi` - 150 - Sets the resolution to 150 dots per inch

```{r save_output, warning=FALSE}
### Save the Map
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country", 
                                   map_title = "2016 Healthy Life Expectancy (HALE) at Birth",
                                   map_legend_title = "HALE (years)",map_x_label = "Longitude", 
                                   map_y_label = "Latitude", output_file = "E:/temp/example_map.png",
                                   dpi = 150 )
```

You should verify that the file saved to the chosen directory. If it did not, or if there was an error, double check your path and use of \\ and /.

### Bins

A choropleth map usually contains a range of values that need to be divided into categories, or "bins". The number of bins as well as the method of categorization are both customizable within this function. The arguments that control this functionality are `bins` (default 8) and `bin_method` (default "pretty"). The `bins` argument will vary based on your individual data, but should reflect the desired number of categories in which to appropriately subdivide the dataset. The `bin_method` argument must be one of "quantile", "equal", "pretty", or "kmeans". A description of these methods is available in the classIntervals description, or simply type help("classIntervals") in your R console. Note that it is possible for the system to override the number of bins depending on which `bin_method` is selected, the number of `bins` entered, and the particulars of your dataset. If this happens and is a problem, reexamine your dataset and its relation to the `bin_method` and number of `bins` defined. 

The arguments added in this call:

* `bins` - 4 - Tells the function to try to use 4 bins
* `bin_method` - "equal" - Sets the method for constructing bins to 'equal'

```{r customize_bins, warning=FALSE}
### Customize bins and bin method
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country", 
                                   map_title = "2016 Healthy Life Expectancy (HALE) at Birth",
                                   map_legend_title = "HALE (years)",map_x_label = "Longitude", 
                                   map_y_label = "Latitude", output_file = "E:/temp/example_map.png",
                                   dpi = 150, bins = 4, bin_method = "equal" )
plot(output)
```

Note that there are now 4 bins as specified, and each category is now 7.8 years in length from using the "equal" method.


### Color Palettes

In addition to layout and formatting, the color scheme for the map can also be customized. This can be done in several ways. The `map_palette_reverse` argument can be set to TRUE, which inverts the current color scheme. The `map_palette_type` argument can be set to one of three presets: "seq" for sequential data, "div" for divergent data, and "qual" for qualitative data sets. By using this option, you will use the preselected JGCRI defaults for that map type. Finally, the palette can be directly changed with the `map_palette` argument. The `map_palette` argument can be set to any palette type from the RColorBrewer package. To view the list of available palettes go to https://colorbrewer2.org/ or type display.brewer.all() in your R console (remember to load library). Note that using the `map_palette` option overrides the `map_palette_type` variable.

The arguments added in this call:

* `map_palette_reverse` - FALSE - Tells the function to not invert the chosen map palette (unchanged, here for reference)
* `map_palette_type` - "seq" - Sets the palette to sequential data default palette (will be overriden by `map_palette`)
* `map_palette` - "Spectral" - Overrides the palette and sets it to the Spectral palette

```{r customize_palette, warning=FALSE}
### Customize palette
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country", 
                                   map_title = "2016 Healthy Life Expectancy (HALE) at Birth",
                                   map_legend_title = "HALE (years)",map_x_label = "Longitude", 
                                   map_y_label = "Latitude", output_file = "E:/temp/example_map.png",
                                   dpi = 150, bins = 8, bin_method = "pretty", map_palette_reverse = FALSE,
                                   map_palette_type = "seq", map_palette = "Spectral")
plot(output)
```


### Customizing the shape fields

There are a number of shape specific options that can also be customized if needed. The most important is the `shape_geom_field`, which controls which field within the shape object is used to plot the shape geometry. The standard field name is "geometry", which is set to the default. However if your shape object is non-standard, then you must inspect it and determine which field to use. The other argument that controls how the shape object gets plotted is `shape_xy_fields`, which has a default of c("LON", "LAT"). This field designates how to generate the x and y axes using data from the shape object. Like the `shape_geom_field`, if your shape is different or non-standard, you must inspect and determine the correct value.

Other shape related fields that control output are `simplify`, `shape_label_field`, and `shape_label_size`. The `simplify` argument can be set to TRUE, which runs an algorithm to reduce the complexity and amount of lines that are drawn, which can improve map aesthetics and/or rendering time in certain situations. The `shape_label_field` and `shape_label_size` work together to provide optional geographic labels such as country name. When not NULL, `shape_label_field` uses the designated field to generate labels and `shape_label_size` controls how big those labels are (this can be customized up or down in size, depending on value).

The arguments added in this call:

* `shape_geom_field` - "geometry" - Tells the function to not invert the chosen map palette (unchanged, here for reference)
* `shape_xy_fields` - "c("LON", "LAT") - Sets the palette to sequential data default palette (will be overriden by `map_palette`)
* `simplify` - "Spectral" - Overrides the palette and sets it to the Spectral palette
* `shape_label_field` - "Spectral" - Overrides the palette and sets it to the Spectral palette
* `shape_label_size` - "Spectral" - Overrides the palette and sets it to the Spectral palette

```{r customize_shape, warning=FALSE}
### Customize palette
output <- gcammaptools::choropleth(shape_data = shape_file, shape_key_field = "NAME", data_col = "X2016",
                                   map_data = data_file, data_key_field = "Country", 
                                   map_title = "2016 Healthy Life Expectancy (HALE) at Birth",
                                   map_legend_title = "HALE (years)",map_x_label = "Longitude", 
                                   map_y_label = "Latitude", output_file = "E:/temp/example_map.png",
                                   dpi = 150, bins = 8, bin_method = "pretty", map_palette_reverse = FALSE,
                                   map_palette_type = "seq", map_palette = "Spectral",
                                   shape_geom_field = "geometry", shape_xy_fields = c("LON", "LAT"),
                                   simplify = TRUE, shape_label_field = "NAME", shape_label_size = 0.2)
plot(output)
```


### Customizing additional map output fields 
map_font_adjust = 1.0)  map_width_height_in = c(15, 10),expand_xy = c(0, 0),
                       map_xy_min_max = c(-180, 180, -90, 90)

<!-- ```{r load.map, fig.width=4, fig.align='center'} -->
<!-- mapdata <- system.file("extdata/rgn32", "reg32_spart.shp", package = "gcammaptools") -->
<!-- mapdata -->
<!-- plot_GCAM(mapdata) -->
<!-- ``` -->

<!-- ## Figures -->

<!-- The figure sizes have been customised so that you can easily put two images side-by-side.  -->

<!-- ```{r, fig.show='hold'} -->
<!-- plot(1:10) -->
<!-- plot(10:1) -->
<!-- ``` -->

<!-- You can enable figure captions by `fig_caption: yes` in YAML: -->

<!--     output: -->
<!--       rmarkdown::html_vignette: -->
<!--         fig_caption: yes -->

<!-- Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**. -->

<!-- ## More Examples -->

<!-- You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`. -->

<!-- ```{r, echo=FALSE, results='asis'} -->
<!-- knitr::kable(head(mtcars, 10)) -->
<!-- ``` -->

<!-- Also a quote using `>`: -->

<!-- > "He who gives up [code] safety for [code] speed deserves neither." -->
<!-- ([via](https://twitter.com/hadleywickham/status/504368538874703872)) -->
