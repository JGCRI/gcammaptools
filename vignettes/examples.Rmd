--- 
title: "GCAM Mapping Tools Examples"
author: "Catherine Ledna and Robert Link"
date: "18 December, 2016"
output:  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GCAM Mapping Tools Examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
--- 

# GCAM Mapping Tools Examples

## Introduction
This vignette explains how to use the GCAM Mapping Tools package to display GCAM data in map form.  Using this package has a couple of advantages over rolling your own maps.  First, it's easy.  By the time you've worked through these examples, you will be able to make maps of GCAM data with just a few simple commands.  Second, we have defined some default projections and extents for common use cases.  This will ensure that the maps you make look professional and conform to the GCAM house style.

```{r checknamespace, echo=FALSE}
if(!requireNamespace('rgcam', quietly=TRUE)) {
    stop('The rgcam package is required to build this vignette')
}
```

## Setup
To get started with the GCAM map tools, attach the `gcammaptools` package.
```{r setup}
library('gcammaptools')
```

## Loading GCAM data
You will need to load your own GCAM data to work with.  The best way to import GCAM results is to use the `rgcam` package, which will create a project file with your data in it.  You can then load the project data with `rgcam::loadProject()` and retrieve tables for individual queries using `rgcam::getQuery()`.  However, if you aren't using `rgcam`, you can start with any data frame that has a `region` column and one or more data columns.

```{r load_data, warning=FALSE}
library('rgcam')
### Load the example scenario data.
prj <- loadProject(system.file('sample-gcam-data','gcam-longform-sample.dat', package='gcammaptools'))
listScenarios(prj)
listQueries(prj, 'Reference')
```

The sample data has one scenario with 19 queries.  For demonstration purposes we will load the CO<sub>2</sub> emissions table. After loading the query you want to display, you must add the region identifiers used in the map data to the data frame using the `add_region_ID()` function.

```{r get_query}
co2 <- rgcam::getQuery(prj, 'CO2 emissions by region', 'Reference')
co2 <- add_region_ID(co2, lookupfile=rgn32, drops=rgn32)
co2 <- dplyr::filter(co2, year==2050)

### Show the first 10 observations
co2[1:10, ]
```
The data is in long form, so using `dplyr::filter()`  helps to get just the observations for the year you want to plot.  At the end of this, `co2` is a data frame that has CO<sub>2</sub> emissions by region for the year 2050.  This structure can now be passed to `plot_GCAM()` to plot maps, as shown in the examples below.

## Loading map data
When using `plot_GCAM()` for your GCAM data, you also need to provide the map data that it should be associated with.  Generally you should use one of the map datasets included in the package whenever possible because they correspond to the geographical units reported by GCAM.  The datasets available are `map.rgn32`, `map.rgn14`, `map.basin235`, and `map.chn`.  They correspond to the 32-region and 14-region GCAM region maps, the 235 global water basin map, and the 32 regions plus China subregions map. Additionally, each of those datasets has a simplified version which is helpful if you need faster plotting or less cluttered maps. 
```{r plot.default, fig.width=3.48, fig.show='hold'}
plot_GCAM(map.rgn32, title="Full 32-Region map")
plot_GCAM(map.rgn32.simple, title="Simplified 32-Region map")
```

It is possible, however, for you to load your own map data as well.  The map data can be loaded by the package given the file path.  Your map data can be in any of the following formats: sf objects, spatial data frames, ESRI Shapefiles, or GeoJSON files.  You can either pass the name of the file (the full file path) to `plot_GCAM()` or load the data yourself first.
```{r load.map, fig.width=4, fig.align='center'}
mapdata <- system.file("extdata/rgn32", "reg32_spart.shp", package = "gcammaptools")
mapdata
plot_GCAM(mapdata)
```
This gives you the same structure you would have gotten with `data(map.rgn32)`.  Generally you should use one of the map datasets included in the package whenever possible because they correspond to the geographical units reported by GCAM.  The datasets available are `map.rgn32`, `map.rgn14`, `map.basin235`, and `map.chn`.  They correspond to the 32-region and 14-region GCAM region maps, the 235 global water basin map, and the 32 regions plus China subregions map.

## Sample Maps generated with plot_GCAM and GCAM32 shapefile

### Example 1: Eckert III World Projection, Colored by Region

This example just plots the map data frame with the GCAM region id.  Thus, you get each region colored according to a discrete color palette.
```{r mp1, fig.width=6, fig.height=3}
plot_GCAM(mapdata, col = 'region_id', proj = eck3)
```

### Example 2: Robinson World Projection, Colored by Regional CO<sub>2</sub> Emissions
In this example we plot the map data frame of CO<sub>2</sub> that we created above.  We select the column for model year 2050.  We also use a different projection than we used above.
```{r mp2, fig.width=6, fig.height=4}
plot_GCAM(mapdata, col='value', proj=robin, extent=EXTENT_WORLD,
          title="Robinson World", legend=T, gcam_df=co2, gcam_key='id',
          mapdata_key="region_id")
```

### Example 3: U.S. Projection (Albers Equal Area)
This map is specialized to the continental USA.  The `na_aea` and `EXTENT_USA` symbols are defined for convenience, but you can use any valid proj4 string (see `proj4::project` for how these strings are constructed) for the projection.  The extent should be the bounding box of the plot area in the form `c(lon.min, lon.max, lat.min, lat.max)`.
```{r mp3, fig.width=4, fig.height=4, fig.align='center'}
plot_GCAM(mapdata, col='region_id', proj=na_aea, extent=EXTENT_USA, 
          title="USA Albers Equal-Area", legend=T)
```

### Example 4: China Projection (Albers Equal Area)
A map of China.  Although the projection is once again the Albers equal area projection, we have to have a different projection string because the string includes some information about the parallels the projection is based on.
```{r mp4, fig.width=4, fig.height=4, fig.align='center'}
plot_GCAM(mapdata, proj=ch_aea, extent=EXTENT_CHINA, title="China Albers Equal-Area")
```

### Example 5: Africa Projection (Orthographic)
For superregions with a long north-south extent, the orthographic projection gives the best result. We have predefined one for Africa, but you can find others defined by proj4 strings from spatialreference.org as shown in the following example. Although the extent parameter is the best way to specify the view you want, you can fine-tune the final plot by adjusting the zoom.
```{r mp5, fig.width=4, fig.height=4, fig.align='center'}
plot_GCAM(mapdata, col='region_id', proj=af_ortho,
          extent=EXTENT_AFRICA, zoom=10)
```

### Example 6: Latin America Projection (Orthographic)
Orthographic projection of the Latin America superregion. Notice that projection strings can also be defined by specifying an EPSG, ESRI, or SR-ORG projection code.
```{r mp6, fig.width=4, fig.height=4, fig.align='center'}
plot_GCAM(mapdata, col='region_id', proj=7567, proj_type='SR-ORG', extent=EXTENT_LA, zoom=8)
```

### Example 7: Global Water Basins
A map of the 235 global water basins.
```{r mp7, fig.width=6, fig.height=3}
plot_GCAM(map.basin235, col = 'GCAM_ID_1', proj = eck3)
```

### Example 8: Gridded Data
The `plot_GCAM_grid()` function tiles gridded data over a base map.
```{r mp8, fig.width=6, fig.height=3}
co2grid <- rgcam::getQuery(prj, 'Cooling Degree Days', 'Reference')
plot_GCAM_grid(co2grid, col='value', proj=robin, extent=EXTENT_LA, zoom=8)
```
